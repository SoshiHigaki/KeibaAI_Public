# 競馬ソフト
### 競馬における馬の順位を予測するソフト

google colab にて一連の流れを体験することができます。
[google colab](https://colab.research.google.com/drive/1UD0edjMjBPdkkzhGdDKij3Ija1s3vYx6?usp=sharing)

# 概要
1. データ収集
   - 情報源
  
        netkeibaというサイトに過去のレースや馬・ジョッキー・調教師のデータが蓄積されているので、そちらを利用する。
        
    - データの条件
  
        データベースは条件を指定して取得することができる。今回は、レースデータ・馬のデータ・ジョッキーデータ・調教師データのそれぞれにおいて、以下の条件のデータを利用した。

        - レースデータ
          - 競争種別 : 芝・ダート
          - 期間 : 2020年1月~2024年3月
          - 競馬場 : 中央・地方のすべて
          - 馬場状態 : 指定なし
          - 馬齢 : 指定なし
          - 距離 : 指定なし
  
        - 馬データ
          - 過去のすべてのレース
  
        - ジョッキーデータ・調教師データ
          - 年度別成績
  
        それぞれのデータはwebスクレイピングで収集する。

2. データの前処理
    - 利用する特徴
      - 馬のデータ
        - 馬番号
        - 斤量
        - コースの長さ
        - 開催月
        - 馬の年齢
        - 馬の性別
        - 馬の体重
        - 馬の体重の変化
        - コースのタイプ (ダート or 芝)
        - 天気
        - 馬場状態 

      - ジョッキーデータ・調教師データ
        - 勝率
        - 連対率
        - 複勝率

    - 特徴量スケーリング
      - 標準化



3. 機械学習モデルの作成

    - 課題 : 目的変数として「着順」を利用していいのか?

        機械学習モデルが予想すべき特徴である目的変数を「着順」にするのは適切なのだろうか。最終的に知りたいのはその馬がレースで何番目にゴールするかである「着順」であるから、「着順」を目的変数にするのは自然な考えである。しかし、「着順」というのは一緒に走る他の馬と比較した相対的な指標である。つまり、優秀な馬でもハイレベルなレースでは着順が低くなるし、優秀でない馬でもレベルの低いレースなら着順が高くなる可能性がある。よって「着順」というのは馬の能力を公平に反映した指標ではなく、これを目的変数にするとうまく学習されない可能性がある。

    - 提案手法
        - 目的変数

            機械学習で競馬ソフトを作成している例のほとんどは「着順」を目的変数にしているが、ここでは「着順」ではなく「馬の速度」を目的変数とする。しかし、「馬の速度」も公平な指標ではない。走る距離や馬場状態、コースのタイプによって同じ馬でも速度は変わってくる。そこで独自の指標として「速度指数」を導入する。

        - 「速度指数」とは

            速度指数はここで提案する独自の指標で、「環境条件から考えられる速度に対して、どれくらい差があるか」を示す値である。過去のレースを基にして、「馬が走る環境」から妥当である速度を割り出し、馬が実際に走った速度とどれくらい差があるかを計算する。例えば「芝、雨、馬場重、10月、斤量55kg」という環境で妥当な速度が15m/sだと割り出されたとして、実際に走った速度が17m/sだったとすると、その馬の速度指数は2ということになり、この馬は優秀であると評価できる。

        - 予想方法

            馬の過去の成績から速度指数を計算し、それを馬の成績とする。それに加えて、ジョッキー・調教師の年度別成績も利用して、本レースの馬の速度指数を予測し、速度指数が大きな馬ほど好成績であると想定する。

        - 提案モデル

            2つのモデルを構成・活用する。環境から妥当な速度を割り出す「VelocityEvaluationNetwork」と、過去の馬の速度指数・ジョッキーと調教師の過去成績から、本レースの馬の速度指数を求める「SpeedIndexNetwork」である。

            - VelocityEvaluationNetwork

                説明変数
                - 馬番号
                - 斤量
                - コースの長さ
                - 開催月
                - 馬の年齢
                - 馬の性別
                - 馬の体重
                - 馬の体重の変化
                - コースのタイプ (ダート or 芝)
                - 天気
                - 馬場状態 

                目的変数
                - 速度

                レースに関わるデータを説明変数にして、速度を目的変数にすることで、レースのデータから考えられる妥当な速度を割り出すことができる。
            
            - SpeedIndexNetwork

                目的関数
                - 過去5レースの馬の速度指数
                - ジョッキー・調教師の前年の年間成績における「勝率、連対率、複勝率」


4. 機械学習モデルの学習、検証

    - 使用データ : 2020年1月~2024年3月
    - 学習回数 : 500エポック (Early Stopあり)

    学習結果　損失の推移
   ![result](https://github.com/SoshiHigaki/KeibaAI_Public/assets/145969282/6d3d8979-f006-479e-82d7-1633b01db74e)


5. シミュレーション
    
    実際にシミュレーションしてみる。

    - 予想の仕方

        あるレースを予測する方法を説明する。あるレースを走るすべての馬に対して速度指数を計算する。その速度指数に基づいてそれぞれの馬のレース内の偏差値を計算する。そして、ある偏差値以上の馬には100円を単勝でかけて、そのリターンを求める。賭ける基準となる偏差値をさまざま変化させて、どのようなリターンになるを計測する。

    - 結果
    2023年の一年間のレースを対象にシミュレーションを行った。
   ![2023-return](https://github.com/SoshiHigaki/KeibaAI_Public/assets/145969282/59316d7b-cd27-4776-84c4-1cd94e3692fd)

    グラフから、偏差値が78以上の馬にかければリターンの方が大きくなること結果になった。
